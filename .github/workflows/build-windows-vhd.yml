name: Build or Test on Hyper-V Runner

on:
  push:
    branches:
      - main

jobs:
  build-vhd:
    name: Run on Hyper-V Self-Hosted Runner
    runs-on:
      - self-hosted
      - windows
      - hyperv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display runner info
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Labels: $RUNNER_LABELS"
          echo "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Ensure Hyper-V is available
        shell: pwsh
        run: |
          Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"& { 
            $hv = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
            if ($hv.State -ne 'Enabled') {
              Write-Error 'Hyper-V feature is not enabled on this host.'
            } else {
              Write-Output 'Hyper-V is enabled.'
            }
          }`"" -Verb RunAs -Wait

      - name: Install Chocolatey if not installed
        shell: pwsh
        run: |
          Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"& { 
            if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Write-Output 'Chocolatey is not installed. Installing...'
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
              Write-Output 'Chocolatey installed successfully.'
            } else {
              Write-Output 'Chocolatey is already installed.'
            }
          }`"" -Verb RunAs -Wait

      - name: Install Packer using Chocolatey
        shell: pwsh
        run: |
          Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"& { 
            if (-not (Get-Command packer -ErrorAction SilentlyContinue)) {
              Write-Output 'Packer is not installed. Installing via Chocolatey...'
              choco install packer -y
              Write-Output 'Packer installed successfully.'
            } else {
              Write-Output 'Packer is already installed.'
            }
          }`"" -Verb RunAs -Wait

      - name: Create and remove a temporary VM
        shell: pwsh
        run: |
          Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"& { 
            $vmName = 'temp-test-vm'
            try {
              if (Get-VM -Name $vmName -ErrorAction SilentlyContinue) {
                Stop-VM -Name $vmName -Force -ErrorAction SilentlyContinue
                Remove-VM -Name $vmName -Force -ErrorAction SilentlyContinue
              }
              New-VM -Name $vmName -MemoryStartupBytes 512MB -Generation 2 | Out-Null
              Write-Output "Created VM: $vmName"
              Remove-VM -Name $vmName -Force
              Write-Output "Removed VM: $vmName"
            } catch {
              Write-Error "An error occurred while managing the VM: $_"
              exit 1
            }
          }`"" -Verb RunAs -Wait