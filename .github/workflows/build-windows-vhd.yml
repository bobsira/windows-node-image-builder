name: Build or Test on Hyper-V Runner

on:
  push:
    branches:
      - main

jobs:
  build-vhd:
    name: Run on Hyper-V Self-Hosted Runner
    runs-on:
      - self-hosted
      - windows
      - hyperv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display runner info
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Labels: $RUNNER_LABELS"
          # In Windows PowerShell runner, you can also query:
          echo "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Ensure Hyper-V is available
        shell: pwsh
        run: |
          # Elevate the script to check Hyper-V feature
          Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"& { 
            $hv = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
            if ($hv.State -ne 'Enabled') {
              Write-Error 'Hyper-V feature is not enabled on this host.'
            } else {
              Write-Output 'Hyper-V is enabled.'
            }
          }`"" -Verb RunAs -Wait

      - name: Create and remove a temporary VM
        shell: pwsh
        run: |
          $vmName = "temp-test-vm"
          # Cleanup if exists
          if (Get-VM -Name $vmName -ErrorAction SilentlyContinue) {
            Stop-VM -Name $vmName -Force
            Remove-VM -Name $vmName -Force
          }
          # Create a minimal generation 2 VM (no OS) just to test Hyper-V commands
          New-VM -Name $vmName -MemoryStartupBytes 512MB -Generation 2 | Out-Null
          Write-Output "Created VM $vmName"
          # Remove it immediately
          Remove-VM -Name $vmName -Force
          Write-Output "Removed VM $vmName"